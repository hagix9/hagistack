---

- name: make temporary image directory
  file: >
    path={{ glance_image_tmp_dir }}
    owner=root
    group=root
    mode=0755
    state=directory

- name: get direct images
  get_url: >
    url={{ item.url }}
    dest={{ glance_image_tmp_dir }}/{{ item.filename }}
    mode=0644
  with_items: glance_direct_images
  when: http_proxy is not defined

- name: get direct images use proxy
  get_url: >
    url={{ item.url }}
    dest={{ glance_image_tmp_dir }}/{{ item.filename }}
    mode=0644
  with_items: glance_direct_images
  environment: "{{ proxy_env }}"
  when: http_proxy is defined

#- name: install libguestfs-tools
#  apt: >
#    pkg=libguestfs-tools
#    state=installed

#- name: install libstring-mkpasswd-perl
#  apt: >
#    pkg=libstring-mkpasswd-perl
#    state=installed

#- name: change cirros password 
#  shell: >- 
#    mkpasswd.pl {{ cirros_password }}
#  ignore_errors: True

- name: direct image registeration
  glance: >
    name={{ item.name }}
    file={{ glance_image_tmp_dir }}/{{ item.filename }}
    format={{ item.format }}
    is_public=true
    auth_url=http://{{ controller_int_ip }}:5000/v2.0
    username={{ admin_user }}
    tenant_name={{ admin_tenant }}
    password={{ admin_password }}
    region={{ region }}
    endpoint_type=publicURL
  with_items: glance_direct_images

